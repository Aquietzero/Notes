# HTTP
------

Web的应用层协议是**超文本传输协议**。Web浏览器实现了HTTP的客户机端，Web服务器实现了HTTP的服务器端。HTTP使用TCP作为其支撑运输层协议，即一旦客户机发送了一个请求报文，该报文就“脱离客户机控制”并“进入TCP控制”。TCP为HTTP提供可靠传输服务，这意味着进程发出的每个HTTP请求报文最终都能完整到达客户机，反之亦然。同时，HTTP是一个**无状态协议**，即服务器向客户机发送被请求的文件时，并不存储任何关于该客户机的状态信息。

## 持久连接和非持久链接

+ 非持久连接 每个请求/相应对是经过一个单独的TCP连接发送。
+ 持久连接 所有的请求和相应都是经由相同的TCP连接发送。

非持久连接有几个缺点。首先，必须为每一个请求的对象建立和维护一个全新的连接。对于每个这样的连接，在客户机和服务器都要分配TCP的缓冲区和变量，这给服务器带来了严重的负担，因为一台Web服务器可能同时服务于数千个客户机。其次，每一个对象的传输时间为两个RTT，即一个RTT用于建立TCP连接，另一个RTT用于请求和接受一个对象。

## HTTP报文 

### HTTP请求报文

以下是一个HTTP请求报文的例子

    GET /somedir/page.html HTTP/1.1
    Host: nullspace.info
    Connection: close
    User-agent: Mozilla/9.0
    Accept-language: fr

HTTP请求报文的第一行叫做**请求行**，其后继的行称为**首部行**。请求行有三个字段：方法字段，URL字段和HTTP协议版本字段。方法字段可以为：GET，POST，HEAD，PUT，DELETE。URL字段是请求对象，版本字段是指浏览器所实现的HTTP协议的版本。

首部行的Host定义了目标所在的主机，Connection指名是否使用持久连接，如果是close则说明使用的是非持久连接，要求发送完请求对象以后就关闭连接。User-agent指名用户代理，即客户端版本。Accept-language即希望得到该对象的某个语言版本。

### HTTP响应报文

以下是一个HTTP响应报文的例子

    HTTP/1.1 200 OK
    Connection: close
    Date: Sat, 07 Jan 2012 20:11:47 GMT
    Server: Apache/1.3.0 (Unix)
    Last-Modified: Sun, 6 May 2007 09:23:24 GMT
    Content-Length: 6821
    Content-type: text/html

    (data data data ...)

第一行是**初始状态行**，接下来的是**首部行**，然后是**实体主体**。状态行分为三个部分：HTTP协议版本，状态码以及状态信息。一些常见的状态码如下：

+ 200 OK：请求成功，信息包含在返回的相应报文中。
+ 301 Moved Permanently：请求的对象已经被永久转移了，新的URL定义在相应报文的Location，在首部行中定义。客户机软件自动用新的URL获取该对象。
+ 400 Bad Request：一个通用的差错代码，指示该请求不能被服务器理解。
+ 404 Not Found：被请求的文档不在服务器上。
+ 505 HTTP Version Not Supported：服务器不支持请求报文所使用的HTTP协议版本。

## Cookie

cookie技术的四个组成部分：

1. 在HTTP响应报文中有一个cookie首部行。
2. 在HTTP请求报文中有一个cookie首部行。
3. 在用户端系统中保留有一个cookie文件，由用户浏览器管理。
4. 在Web站点有一个后端数据库。

在用户第一次访问A站点的时候，A站点会产生一个唯一识别码，并以此作为索引在它的后端数据库中产生一个表项，接下来A站点的Web服务器用一个含Set-cookie首部行的响应报文对用户浏览器做出反应，其Set-cookie首部行的值正是产生出来的识别码。当用户浏览器收到响应报文的时候，会看到Set-cookie首部行，此时浏览器会在它管理的cookie文件中添加一行。其中包含A站点主机名以及Set-cookie中的识别码。当用户再次访问A站点的时候，浏览器会发送带有Cookie首部行的请求报文，其中Cookie首部行的值就是当前请求访问站点所对应的cookie识别码。这样当请求报文到达该站点的服务器时，服务器就能够根据识别码从数据库中调出该用户的数据了。

## Web缓存

Web缓存器实际上也被称为**代理服务器**，它是能够代表初始Web服务器来满足HTTP请求的网络实体。其工作过程如下：

1. 浏览器建立一个到Web缓存器的TCP连接，并向Web缓存器中的对象发送一个HTTP请求。
2. Web缓存器检查本地是否存储了该对象拷贝。如果有，Web缓存器就用HTTP响应报文想客户机浏览器返回该对象。
3. 如果Web缓存器没有该对象，它就与该对象的初始服务器打开一个TCP连接。Web缓存器则在TCP连接上发送获取该对象的HTTP请求。在收到请求后，初始服务器向Web缓存器发送具有该对象的HTTP响应。
4. 当Web缓存器接受该对象时，它在本地存储空间中存储一份拷贝，并用HTTP响应报文想客户机的浏览器发送该拷贝。
